{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["const inBrowser = typeof window !== 'undefined'\n\nif(inBrowser){\n  window.createHelper = createHelper;\n}\n// TODO: 1. abstract mode support 2. replace white list\nexport default function createHelper(config) {\n\n  if(config.Vue === undefined || config.router === undefined){\n    console.warn(\"warning: router helper needs Vue and root router ,see more for guide : https://github.com/Zippowxk/vue-router-keep-alive-helper\")\n    return;\n  }\n  const Vue = config.Vue;\n  const router = config.router;\n  const mode = router.mode; //hash or history  //TODO: abstract\n  const replaceStay = config.replaceStay || []\n  let hacked = false;\n  router._stack = 0;\n  let pre;\n  let isReplace = false;\n  let replacePrePath = undefined;\n  let preStateId = 0;\n\n  router.beforeEach((to, from, next) => {\n    pre = getCurrentVM();\n    next();\n  })\n\n  router.afterEach((to, from) => {\n    // get the vm instance after render\n    Vue.nextTick(() => {\n      if (pre === undefined) {\n        initialCb(to);\n        console.log(\"init\")\n      } else if (isReplace) {\n        replaceCb();\n        console.log(\"replace\")\n      } else if (isPush()) {\n        pushCb();\n        console.log(\"push\")\n      } else {\n        backCb();\n        console.log(\"back\")\n      }\n      preStateId = Number(router._stack);\n      setCurrentVnodeKey();\n      const current = getCurrentVM();\n      if(!hacked && current){\n        hackKeepAliveRender(current.$vnode.parent.componentInstance);\n      }\n    })\n  })\n\n  // hack router.replace function\n  const rtmp = router.replace;\n  router.replace = function(arg, complete, abort) {\n    isReplace = true;\n    replacePrePath = router.history.current.path;\n    rtmp.apply(router, [arguments[0]]);\n  }\n\n  /** ********  callback functions ************/\n  const initialCb = function(to) {\n    \n  }\n  const pushCb = function() {\n    router._stack++;\n    setState(router._stack)\n  }\n  const backCb = function() {\n    router._stack--;\n    pre.$keepAliveDestroy();\n  }\n  const replaceCb = function() {\n    if(!(isDef(replacePrePath) && replaceStay.indexOf(replacePrePath) != -1)){\n      pre.$keepAliveDestroy();\n    }\n    isReplace = false;\n    replacePrePath = undefined;\n  }\n  /*********** hack keep alive render *******************/\n\n  const hackKeepAliveRender = function(vm){    \n    // modify the first keep alive key and catch\n    replaceFirstKeyAndCache(vm,genKey(router._stack))\n    \n    const tmp = vm.$options.render \n    vm.$options.render = function(){\n      const slot = this.$slots.default;\n      const vnode = getFirstComponentChild(slot) //vnode is a keep-alive-component-vnode\n      if(!isDef(vnode.key)){\n        if(isReplace){\n          vnode.key = genKey(router._stack)\n        }else if(isPush()){\n          vnode.key = genKey(Number(router._stack)+1)\n        }else{\n          vnode.key = genKey(Number(router._stack)-1)\n        }\n      }\n      return tmp.apply(this,arguments)\n    }\n    hacked = true;\n  }\n\n  /** ********* router helper ************/\n  const getStateId = function (){\n    const state = getCurrentState();\n    return isDef(state)?state.id:undefined\n  }\n  const setState = function(id){\n    console.log(router.history.current.path);\n    // optimize file:// URL\n\n    let path = (mode === \"hash\"?\"#\":\"\")+ router.history.current.path;\n    if(window.location.href.startsWith(\"file://\")){\n      let pre;\n      if(mode === \"hash\"){\n        pre = window.location.href.split(\"#\")[0];\n      }else{\n        pre = window.location.href.splice(\".html\")[0] + '.html';\n      }\n      path = pre + path;\n      console.log(path);\n    }\n    history.replaceState({id},\"\",path)\n  }\n  const getCurrentState = function(){\n    return history.state\n  }\n\n  const isPush = function() {\n    if(!isReplace){\n      return !isDef(getStateId()) || preStateId < getStateId()\n    }\n    return false;\n  }\n\n  const genKey = function(num){\n    return \"keep-alive-vnode-key\" + Number(num) + router.history.current.path\n  }\n  const genVNodeKey = function(num){\n      return \"vnode-key\"+ Number(num) + router.history.current.path \n  }\n  const getCurrentVM = function() {\n    return router.history.current.matched.length > 0 ? router.history.current.matched[0].instances.default : undefined;\n  }\n  const setCurrentVnodeKey = function() {\n    const current = getCurrentVM();\n    if (current && current._vnode) { \n      current._vnode.key = genVNodeKey(router._stack)\n      current._vnode.parent.key = genKey(router._stack)\n    }\n  }\n\n\n  /** ******** depend functions ************/\n  // add $keepAliveDestroy function to every vm instance instand of $destroy function\n  // remove vnode in cache vnodes when destroy a keep-alive instance,\n  // just in case reuse previous vm instance of this vnode when push to the same page second time\n  const replaceFirstKeyAndCache = function(vm,key){\n    if(!isDef(vm) || !isDef(vm.cache) || !isDef(vm.keys)){return}\n    const keys = vm.keys;\n    const cache = vm.cache;\n    if(keys.length == 1){\n      const vnode = cache[keys[0]]\n      delete cache[keys[0]]\n      keys.splice(0,1);\n      keys.push(key);\n      cache[key] = vnode;\n    }\n  }\n\n\n  const dtmp = Vue.prototype.$destroy;\n  const f = function() {\n    if (this.$vnode && this.$vnode.data.keepAlive) {\n      if (this.$vnode.parent && this.$vnode.parent.componentInstance && this.$vnode.parent.componentInstance.cache) {\n        if (this.$vnode.componentOptions) {\n          var key = this.$vnode.key == null\n            ? this.$vnode.componentOptions.Ctor.cid + (this.$vnode.componentOptions.tag ? `::${this.$vnode.componentOptions.tag}` : '')\n            : this.$vnode.key;\n          var cache = this.$vnode.parent.componentInstance.cache;\n          var keys = this.$vnode.parent.componentInstance.keys;\n          if (cache[key]) {\n            if (keys.length) {\n              var index = keys.indexOf(key);\n              if (index > -1) {\n                keys.splice(index, 1);\n              }\n            }\n            delete cache[key];\n          }\n        }\n      }\n    }\n    dtmp.apply(this, arguments);\n  }\n  Vue.prototype.$keepAliveDestroy = f;\n\n  // getFirstChild \n  const getFirstComponentChild = function  (children){\n    if (Array.isArray(children)) {\n      for (let i = 0; i < children.length; i++) {\n        const c = children[i]\n        if (isDef(c) && (isDef(c.componentOptions) || isAsyncPlaceholder(c))) {\n          return c\n        }\n      }\n    }\n  }\n  const isAsyncPlaceholder = function (node){\n    return node.isComment && node.asyncFactory\n  }\n  const isDef = function (v) {\n    return v !== undefined && v !== null\n  }\n}"],"names":["createHelper","config","undefined","Vue","router","pre","mode","replaceStay","hacked","_stack","isReplace","replacePrePath","preStateId","beforeEach","to","from","next","getCurrentVM","afterEach","nextTick","console","log","replaceCb","isPush","pushCb","backCb","Number","setCurrentVnodeKey","current","hackKeepAliveRender","$vnode","parent","componentInstance","rtmp","replace","arg","complete","abort","history","path","apply","arguments","setState","$keepAliveDestroy","isDef","indexOf","vm","replaceFirstKeyAndCache","genKey","tmp","$options","render","slot","this","$slots","default","vnode","getFirstComponentChild","key","getStateId","state","getCurrentState","id","window","location","href","startsWith","split","splice","replaceState","num","matched","length","instances","_vnode","cache","keys","push","dtmp","prototype","$destroy","data","keepAlive","componentOptions","Ctor","cid","tag","index","children","Array","isArray","i","c","isAsyncPlaceholder","node","isComment","asyncFactory","v","warn"],"mappings":"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"}