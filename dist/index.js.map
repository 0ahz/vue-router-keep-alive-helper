{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["const inBrowser = typeof window !== 'undefined'\n\nif (inBrowser) {\n  window.createHelper = createHelper;\n}\n// TODO: 1. abstract mode support\nexport default function createHelper(config) {\n  const isDef = function (v) {\n    return v !== undefined && v !== null\n  }\n  if (config.Vue === undefined || config.router === undefined) {\n    console.warn('warning: router helper needs Vue and root router ,see more for guide : https://github.com/Zippowxk/vue-router-keep-alive-helper')\n    return;\n  }\n  const Vue = config.Vue;\n  const router = config.router;\n  const mode = router.mode; // hash or history\n  const replaceStay = config.replaceStay || []\n  let hacked = false;\n  router._stack = 0;\n  let pre;\n  let isReplace = false;\n  let replacePrePath;\n  let preStateId = 0;\n  let historyShouldChange = false;\n  let historyStackMap = {};\n  router.beforeEach((to, from, next) => {\n    pre = getCurrentVM();\n    next();\n  })\n\n  router.afterEach((to, from) => {\n    historyShouldChange = true;\n    // get the vm instance after render\n    Vue.nextTick(() => {\n      if (pre === undefined) {\n        initialCb(to);\n      } else if (isReplace) {\n        replaceCb();\n      } else if (isPush()) {\n        pushCb();\n      } else {\n        backCb();\n      }\n      preStateId = Number(router._stack);\n      setCurrentVnodeKey();\n      const current = getCurrentVM();\n      if (!hacked && current) {\n        hackKeepAliveRender(current.$vnode.parent.componentInstance);\n      }\n      historyShouldChange = false;\n    })\n  })\n  /** ********  callback functions ************/\n  const initialCb = function(to) {\n    if (isDef(getStateId())) {\n      router._stack = getStateId();\n    } else {\n      setState(0);\n    }\n    pushStack(getCurrentVM());\n  }\n  const pushCb = function() {\n    router._stack++;\n    setState(router._stack)\n    pushStack(getCurrentVM());\n  }\n  const backCb = function() {\n    router._stack--;\n    removeGreater(router._stack);\n    pushStack(getCurrentVM());\n  }\n  const replaceCb = function() {\n    if (!(isDef(replacePrePath) && replaceStay.indexOf(replacePrePath) !== -1)) {\n      pre.$keepAliveDestroy();\n    }\n    setState(router._stack)\n    pushStack(getCurrentVM());\n    isReplace = false;\n    replacePrePath = undefined;\n  }\n  /** ********* hack keep alive render *******************/\n\n  const hackKeepAliveRender = function(vm) {\n    // modify the first keep alive key and catch\n    replaceFirstKeyAndCache(vm, genKey(router._stack))\n\n    const tmp = vm.$options.render\n    vm.$options.render = function() {\n      const slot = this.$slots.default;\n      const vnode = getFirstComponentChild(slot) // vnode is a keep-alive-component-vnode\n      if (historyShouldChange) {\n        if (!isDef(vnode.key)) {\n          if (isReplace) {\n            vnode.key = genKey(router._stack)\n          } else if (isPush()) {\n            vnode.key = genKey(Number(router._stack) + 1)\n          } else {\n            vnode.key = genKey(Number(router._stack) - 1)\n          }\n        }\n      } else {\n        // when historyShouldChange is false should rerender only, should not create new vm ,use the same vnode.key issue#7\n        vnode.key = genKey(router._stack)\n      }\n      return tmp.apply(this, arguments)\n    }\n    hacked = true;\n  }\n\n  /** ************* stack map helper **************/\n  const pushStack = function(vm) {\n    const cur = router._stack;\n    if (historyStackMap.hasOwnProperty(cur) && historyStackMap[cur]) {\n      const vms = historyStackMap[cur]\n      vms.push(vm)\n    } else {\n      const vms = []\n      vms.push(vm)\n      historyStackMap[cur] = vms;\n    }\n  }\n  const removeGreater = function(index) {\n    if (!isDef(historyStackMap) || historyStackMap.length <= 0) { return }\n    Object.keys(historyStackMap).forEach(level => {\n      if (level <= index) { return }\n      const vms = historyStackMap[level];\n      if (!isDef(vms) || vms.length <= 0) { return }\n      let vm = vms.pop();\n      while (isDef(vm)) {\n        vm.$keepAliveDestroy();\n        vm = vms.pop();\n      }\n    });\n  }\n\n  /** ********* router helper ************/\n  const getStateId = function () {\n    const state = getCurrentState();\n    return isDef(state) ? state.id : undefined\n  }\n  const setState = function(id) {\n    // optimize file:// URL\n    let path = window.location.pathname + mode === 'hash' ? window.location.hash : '';\n    if (window.location.href.startsWith('file://')) {\n      let pre;\n      if (mode === 'hash') {\n        pre = window.location.href.split('#')[0];\n      } else {\n        pre = window.location.href.splice('.html')[0] + '.html';\n      }\n      path = pre + path;\n    }\n    let query = getQuery(router.history.current.query)\n    path = path + query;\n    let state = isDef(history.state) ? history.state : {};\n    state['id'] = id;\n    history.replaceState(state, '', path)\n  }\n  const getQuery = function (params) {\n    let query = ''\n    query = Object.keys(params)\n      .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)\n      .join('&');\n    if (query.length > 0) {\n      query = '?' + query;\n    }\n    return query;\n  }\n  const getCurrentState = function() {\n    return history.state\n  }\n\n  const isPush = function() {\n    if (!isReplace) {\n      return !isDef(getStateId()) || preStateId < getStateId()\n    }\n    return false;\n  }\n\n  const genKey = function(num) {\n    return 'keep-alive-vnode-key' + Number(num) + router.history.current.path\n  }\n  // const genVNodeKey = function(num) {\n  //   return 'vnode-key' + Number(num) + router.history.current.path\n  // }\n  const getCurrentVM = function() {\n    return router.history.current.matched.length > 0 ? router.history.current.matched[0].instances.default : undefined;\n  }\n  const setCurrentVnodeKey = function() {\n    const current = getCurrentVM();\n    if (current && current._vnode) {\n      // current._vnode.key = genVNodeKey(router._stack)\n      current._vnode.parent.key = genKey(router._stack)\n    }\n  }\n\n  /** ******************hack history replaceState function*******************/\n  const rstmp = history.replaceState;\n  history.replaceState = function(state, op, path) {\n    const old = Object.assign({}, history.state)\n    const s = Object.assign(old, state)\n    rstmp.call(history, s, op, path)\n  }\n  /************************* hack router.replace function ************/\n  const rtmp = router.replace;\n  router.replace = function(location, onComplete, onAbort) {\n    isReplace = true;\n    replacePrePath = router.history.current.path;\n    if (!onComplete && !onAbort && typeof Promise !== 'undefined') {\n      return new Promise(function (resolve, reject) {\n        rtmp.call(router, location).then(() => resolve()).catch(e => {\n          isReplace = false;\n          replacePrePath = undefined;\n          reject(e);\n        });\n      })\n    } else {\n      rtmp.call(router, location, onComplete, (e) => {\n        isReplace = false;\n        replacePrePath = undefined;\n        isDef(onAbort) && onAbort(e);\n      })\n    }\n  }\n  /** ******************hack router go and push functions*******************/\n  const gstmp = router.go;\n  router.go = function(number) {\n    isReplace = false;\n    return gstmp.call(router, number)\n  }\n  const pstmp = router.push;\n  router.push = function(location, onComplete, onAbort) {\n    isReplace = false;\n    if (!onComplete && !onAbort && typeof Promise !== 'undefined') {\n      return pstmp.call(router, location, onComplete, onAbort)\n    } else {\n      pstmp.call(router, location, onComplete, onAbort)\n    }\n  }\n  /** ******** depend functions ************/\n  // add $keepAliveDestroy function to every vm instance instand of $destroy function\n  // remove vnode in cache vnodes when destroy a keep-alive instance,\n  // just in case reuse previous vm instance of this vnode when push to the same page second time\n  const replaceFirstKeyAndCache = function(vm, key) {\n    if (!isDef(vm) || !isDef(vm.cache) || !isDef(vm.keys)) { return }\n    const keys = vm.keys;\n    const cache = vm.cache;\n    if (keys.length === 1) {\n      const vnode = cache[keys[0]]\n      delete cache[keys[0]]\n      keys.splice(0, 1);\n      keys.push(key);\n      cache[key] = vnode;\n    }\n  }\n\n  const dtmp = Vue.prototype.$destroy;\n  const f = function() {\n    if (this.$vnode && this.$vnode.data.keepAlive) {\n      if (this.$vnode.parent && this.$vnode.parent.componentInstance && this.$vnode.parent.componentInstance.cache) {\n        if (this.$vnode.componentOptions) {\n          var key = !isDef(this.$vnode.key)\n            ? this.$vnode.componentOptions.Ctor.cid + (this.$vnode.componentOptions.tag ? `::${this.$vnode.componentOptions.tag}` : '')\n            : this.$vnode.key;\n          var cache = this.$vnode.parent.componentInstance.cache;\n          var keys = this.$vnode.parent.componentInstance.keys;\n          if (cache[key]) {\n            if (keys.length) {\n              var index = keys.indexOf(key);\n              if (index > -1) {\n                keys.splice(index, 1);\n              }\n            }\n            delete cache[key];\n          }\n        }\n      }\n    }\n    dtmp.apply(this, arguments);\n  }\n  Vue.prototype.$keepAliveDestroy = f;\n\n  // getFirstChild\n  const getFirstComponentChild = function (children) {\n    if (Array.isArray(children)) {\n      for (let i = 0; i < children.length; i++) {\n        const c = children[i]\n        if (isDef(c) && (isDef(c.componentOptions) || isAsyncPlaceholder(c))) {\n          return c\n        }\n      }\n    }\n  }\n  const isAsyncPlaceholder = function (node) {\n    return node.isComment && node.asyncFactory\n  }\n}"],"names":["createHelper","config","isDef","v","undefined","Vue","router","pre","mode","replaceStay","hacked","_stack","replacePrePath","isReplace","preStateId","historyShouldChange","historyStackMap","beforeEach","to","from","next","getCurrentVM","afterEach","nextTick","initialCb","replaceCb","isPush","pushCb","backCb","Number","setCurrentVnodeKey","current","hackKeepAliveRender","$vnode","parent","componentInstance","getStateId","setState","pushStack","removeGreater","indexOf","$keepAliveDestroy","vm","replaceFirstKeyAndCache","genKey","tmp","$options","render","slot","this","$slots","default","vnode","getFirstComponentChild","key","apply","arguments","cur","hasOwnProperty","push","vms","index","length","Object","keys","forEach","level","pop","state","getCurrentState","id","path","window","location","pathname","hash","href","startsWith","split","splice","getQuery","history","query","replaceState","params","map","encodeURIComponent","join","num","matched","instances","_vnode","rstmp","op","old","assign","s","call","rtmp","replace","onComplete","onAbort","Promise","resolve","reject","then","catch","e","gstmp","go","number","pstmp","cache","dtmp","prototype","$destroy","data","keepAlive","componentOptions","Ctor","cid","tag","children","Array","isArray","i","c","isAsyncPlaceholder","node","isComment","asyncFactory","console","warn"],"mappings":"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"}