{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["const inBrowser = typeof window !== 'undefined'\n\nif(inBrowser){\n  window.createHelper = createHelper;\n}\n\nexport default function createHelper(config) {\n\n  if(config.Vue === undefined || config.router === undefined){\n    console.warn(\"warning: router helper needs Vue and root router ,see more for guide : https://github.com/Zippowxk/vue-router-keep-alive-helper\")\n    return;\n  }\n  const Vue = config.Vue;\n  const router = config.router;\n  const canRefresh = config.canRefresh === undefined ? true : config.canRefresh;\n  let hacked = false;\n  // When 'canRefresh === true' ,RouterStack will make the stack visible in the query of URL path,\n  // Because when a page can refresh , the vm._stack chain is broken.\n  // The query.routerStack will be used as place B to keep the stack chain\n  router._stack = 0;\n  let pre;\n  let isReplace = false;\n\n  router.beforeEach((to, from, next) => {\n    pre = getCurrentVM();\n    next();\n  })\n\n  router.afterEach((to, from) => {\n    // get the vm instance after render\n    Vue.nextTick(() => {\n      if (pre === undefined) {\n        initialCb(to);\n      } else if (isReplace) {\n        replaceCb();\n        console.log(\"replace\")\n      } else if (isPush(to)) {\n        pushCb();\n        console.log(\"push\")\n      } else {\n        backCb();\n        console.log(\"back\")\n      }\n      setCurrentVnodeKey();\n      const current = getCurrentVM();\n      console.log(current.$vnode.parent.componentInstance.cache);\n      console.log(current.$vnode.parent.componentInstance.keys);\n      if(!hacked){\n        hackKeepAliveRender(current.$vnode.parent.componentInstance);\n      }\n    })\n  })\n\n  // hack router.replace function\n  const rtmp = router.replace;\n  router.replace = function(arg, complete, abort) {\n    isReplace = true;\n    rtmp.apply(router, [arguments[0]]);\n  }\n\n  // hack the router.push , canRefresh mode only\n  if (canRefresh) {\n    const ptmp = router.push;\n    router.push = function(arg, complete, abort) {\n      if (canRefresh) {\n        const current = getCurrentVM()\n        if (typeof arg === 'string') {\n          arg = arg.indexOf('?') !== -1 ? arg + `&routerStack=${current._stack + 1}` : arg + `?routerStack=${current._stack + 1}`\n        } else {\n          if (!arg.query) {\n            arg.query = { 'routerStack': current._stack + 1 }\n          } else {\n            arg.query['routerStack'] = current._stack + 1;\n          }\n        }\n      }\n      ptmp.apply(router, [arguments[0]])\n    }\n  }\n\n  /*********** hack keep alive render *******************/\n\n  const hackKeepAliveRender = function(vm){\n\n    \n    // modify the first keep alive key and catch\n    replaceFirstKeyAndCache(vm,\"keep-alive\" + Number(router._stack) + router.history.current.path)\n    \n    const tmp = vm.$options.render\n    vm.$options.render = function(){\n      const slot = this.$slots.default;\n      const vnode = getFirstComponentChild(slot)\n      // TODO: 非refresh mode 下 可能会导致返回时+1\n\n      console.log('====================================!!!');\n      console.log('====================================');\n      console.log(router.history);\n      \n      if(!isDef(vnode.key)){\n        if(isReplace){\n          vnode.key = \"keep-alive\" + Number(router._stack) + router.history.current.path\n        }else if(isPush(router.history.current)){\n          vnode.key = \"keep-alive\" + Number(Number(router._stack)+1) + router.history.current.path\n        }else{\n          vnode.key = \"keep-alive\" + Number(Number(router._stack)-1) + router.history.current.path\n        }\n      }\n\n      console.log(router.history.current.path);\n      console.log(vnode);\n      return tmp.apply(this,arguments)\n    }\n    hacked = true;\n  }\n\n  /** ********* router helper ************/\n\n  const getKeepAliveVM = function (){\n    const current = getCurrentVM();\n    return current?current.$vnode.parent.componentInstance:pre?pre.$vnode.parent.componentInstance:undefined;\n  }\n  const getCurrentVM = function() {\n    return router.history.current.matched.length > 0 ? router.history.current.matched[0].instances.default : undefined;\n  }\n  const getCurrentVMStack = function() {\n    return getCurrentVM() ? getCurrentVM()._stack : undefined;\n  }\n  const setCurrentVMStack = function(stack) {\n    router.history.current.matched.length > 0 && (router.history.current.matched[0].instances.default._stack = Number(stack));\n  }\n  const setCurrentVnodeKey = function() {\n    const current = getCurrentVM();\n    // console.log(current._vnode)\n    if (current && current._vnode) { \n      current._vnode.key = Number(router._stack) + router.history.current.path \n      current._vnode.parent.key = \"keep-alive\"+ current._vnode.key\n    }\n  }\n  /** ********  callback functions ************/\n  const initialCb = function(to) {\n    if (canRefresh) {\n      if (to.query && to.query.routerStack !== undefined) {\n        setCurrentVMStack(to.query.routerStack);\n        router._stack = to.query.routerStack;\n      } else {\n        setCurrentVMStack(0);\n      }\n    } else {\n      setCurrentVMStack(0);\n    }\n  }\n  const pushCb = function() {\n    router._stack++;\n    setCurrentVMStack(router._stack)\n  }\n  const backCb = function() {\n    router._stack--;\n    if (getCurrentVMStack() === undefined) {\n      setCurrentVMStack(pre._stack - 1)\n    }\n    pre.$keepAliveDestroy();\n  }\n  const replaceCb = function() {\n    setCurrentVMStack(pre._stack)\n    pre.$keepAliveDestroy();\n    isReplace = false;\n  }\n  const isPush = function(to) {\n    // in normal , getCurrentVMStack is undefined only happened when push,\n    // But when refresh mode, getCurrentVMStack is undefined can also happened when popback\n    // In this case , the query.routerStack will be used instand of vm._stack\n\n    const toStack = to.query ? to.query.routerStack !== undefined ? to.query.routerStack : 0 : 0;\n\n    const vm = getCurrentVM();\n    console.log(vm);\n    \n    return (getCurrentVMStack() === undefined && !canRefresh) || (canRefresh && toStack > pre._stack);\n  }\n\n  /** ******** depend functions ************/\n  // add $keepAliveDestroy function to every vm instance instand of $destroy function\n  // remove vnode in cache vnodes when destroy a keep-alive instance,\n  // just in case reuse previous vm instance of this vnode when push to the same page second time\n  const replaceFirstKeyAndCache = function(vm,key){\n    if(!isDef(vm) || !isDef(vm.cache) || !isDef(vm.keys)){return}\n    const keys = vm.keys;\n    const cache = vm.cache;\n    if(keys.length == 1){\n      const vnode = cache[keys[0]]\n      delete cache[keys[0]]\n      keys.splice(0,1);\n      keys.push(key);\n      cache[key] = vnode;\n    }\n  }\n\n\n  const dtmp = Vue.prototype.$destroy;\n  const f = function() {\n    if (this.$vnode && this.$vnode.data.keepAlive) {\n      if (this.$vnode.parent && this.$vnode.parent.componentInstance && this.$vnode.parent.componentInstance.cache) {\n        if (this.$vnode.componentOptions) {\n          var key = this.$vnode.key == null\n            ? this.$vnode.componentOptions.Ctor.cid + (this.$vnode.componentOptions.tag ? `::${this.$vnode.componentOptions.tag}` : '')\n            : this.$vnode.key;\n          var cache = this.$vnode.parent.componentInstance.cache;\n          var keys = this.$vnode.parent.componentInstance.keys;\n          if (cache[key]) {\n            if (keys.length) {\n              var index = keys.indexOf(key);\n              if (index > -1) {\n                keys.splice(index, 1);\n              }\n            }\n            delete cache[key];\n          }\n        }\n      }\n    }\n    dtmp.apply(this, arguments);\n  }\n  Vue.prototype.$keepAliveDestroy = f;\n\n  // getFirstChild \n  const getFirstComponentChild = function  (children){\n    if (Array.isArray(children)) {\n      for (let i = 0; i < children.length; i++) {\n        const c = children[i]\n        if (isDef(c) && (isDef(c.componentOptions) || isAsyncPlaceholder(c))) {\n          return c\n        }\n      }\n    }\n  }\n  const isAsyncPlaceholder = function (node){\n    return node.isComment && node.asyncFactory\n  }\n  const isDef = function (v) {\n    return v !== undefined && v !== null\n  }\n}"],"names":["createHelper","config","undefined","Vue","router","pre","canRefresh","hacked","_stack","isReplace","beforeEach","to","from","next","getCurrentVM","afterEach","nextTick","initialCb","replaceCb","console","log","isPush","pushCb","backCb","setCurrentVnodeKey","current","$vnode","parent","componentInstance","cache","keys","hackKeepAliveRender","rtmp","replace","arg","complete","abort","apply","arguments","ptmp","push","indexOf","query","vm","replaceFirstKeyAndCache","Number","history","path","tmp","$options","render","slot","this","$slots","default","vnode","getFirstComponentChild","isDef","key","matched","length","instances","getCurrentVMStack","setCurrentVMStack","stack","_vnode","routerStack","$keepAliveDestroy","toStack","splice","dtmp","prototype","$destroy","data","keepAlive","componentOptions","Ctor","cid","tag","index","children","Array","isArray","i","c","isAsyncPlaceholder","node","isComment","asyncFactory","v","warn","window"],"mappings":"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"}