{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["const inBrowser = typeof window !== 'undefined'\n\nif(inBrowser){\n  window.createHelper = createHelper;\n}\n\nexport default function createHelper(config) {\n\n  if(config.Vue === undefined || config.router === undefined){\n    console.warn(\"warning: router helper needs Vue and root router ,see more for guide : https://github.com/Zippowxk/vue-router-keep-alive-helper\")\n    return;\n  }\n  const Vue = config.Vue;\n  const router = config.router;\n  const canRefresh = config.canRefresh === undefined ? true : config.canRefresh;\n  // When 'canRefresh === true' ,RouterStack will make the stack visible in the query of URL path,\n  // Because when a page can refresh , the vm._stack chain is broken.\n  // The query.routerStack will be used as place B to keep the stack chain\n  router._stack = 0;\n  let pre;\n  let isReplace = false;\n\n  router.beforeEach((to, from, next) => {\n    pre = getCurrentVM();\n    next();\n  })\n\n  router.afterEach((to, from) => {\n    // get the vm instance after render\n    Vue.nextTick(() => {\n      if (pre === undefined) {\n        initialCb(to);\n      } else if (isReplace) {\n        replaceCb();\n        console.log(\"replace\")\n      } else if (isPush(to)) {\n        pushCb();\n        console.log(\"push\")\n      } else {\n        backCb();\n        console.log(\"back\")\n      }\n      setCurrentVnodeKey();\n      const current = getCurrentVM();\n      console.log(current.$vnode.parent.componentInstance.cache);\n      console.log(current.$vnode.parent.componentInstance.keys);\n    })\n  })\n\n  // hack router.replace function\n  const rtmp = router.replace;\n  router.replace = function(arg, complete, abort) {\n    isReplace = true;\n    rtmp.apply(router, [arguments[0]]);\n  }\n\n  // hack the router.push , canRefresh mode only\n  if (canRefresh) {\n    const ptmp = router.push;\n    router.push = function(arg, complete, abort) {\n      if (canRefresh) {\n        const current = getCurrentVM()\n        if (typeof arg === 'string') {\n          arg = arg.indexOf('?') !== -1 ? arg + `&routerStack=${current._stack + 1}` : arg + `?routerStack=${current._stack + 1}`\n        } else {\n          if (!arg.query) {\n            arg.query = { 'routerStack': current._stack + 1 }\n          } else {\n            arg.query['routerStack'] = current._stack + 1;\n          }\n        }\n      }\n      ptmp.apply(router, [arguments[0]])\n    }\n  }\n\n  /** ********* router helper ************/\n\n  const getCurrentVM = function() {\n    return router.history.current.matched.length > 0 ? router.history.current.matched[0].instances.default : undefined;\n  }\n  const getCurrentVMStack = function() {\n    return getCurrentVM() ? getCurrentVM()._stack : undefined;\n  }\n  const setCurrentVMStack = function(stack) {\n    router.history.current.matched.length > 0 && (router.history.current.matched[0].instances.default._stack = Number(stack));\n  }\n  const setCurrentVnodeKey = function() {\n    const current = getCurrentVM();\n    // console.log(current._vnode)\n    if (current && current._vnode) { \n      current._vnode.key = Number(current._stack) + router.history.current.path \n      current._vnode.parent.key = \"keep-alive\"+ current._vnode.key\n    }\n  }\n  /** ********  callback functions ************/\n  const initialCb = function(to) {\n    if (canRefresh) {\n      if (to.query && to.query.routerStack !== undefined) {\n        setCurrentVMStack(to.query.routerStack);\n        router._stack = to.query.routerStack;\n      } else {\n        setCurrentVMStack(0);\n      }\n    } else {\n      setCurrentVMStack(0);\n    }\n  }\n  const pushCb = function() {\n    router._stack++;\n    setCurrentVMStack(router._stack)\n  }\n  const backCb = function() {\n    router._stack--;\n    if (getCurrentVMStack() === undefined) {\n      setCurrentVMStack(pre._stack - 1)\n    }\n    pre.$keepAliveDestroy();\n  }\n  const replaceCb = function() {\n    setCurrentVMStack(pre._stack)\n    pre.$keepAliveDestroy();\n    isReplace = false;\n  }\n  const isPush = function(to) {\n    // in normal , getCurrentVMStack is undefined only happened when push,\n    // But when refresh mode, getCurrentVMStack is undefined can also happened when popback\n    // In this case , the query.routerStack will be used instand of vm._stack\n\n    return true;\n    const toStack = to.query ? to.query.routerStack !== undefined ? to.query.routerStack : 0 : 0;\n    return (getCurrentVMStack() === undefined && !canRefresh) || (canRefresh && toStack > pre._stack);\n  }\n\n  /** ******** depend functions ************/\n  // add $keepAliveDestroy function to every vm instance instand of $destroy function\n  // remove vnode in cache vnodes when destroy a keep-alive instance,\n  // just in case reuse previous vm instance of this vnode when push to the same page second time\n  const dtmp = Vue.prototype.$destroy;\n  const f = function() {\n    if (this.$vnode && this.$vnode.data.keepAlive) {\n      if (this.$vnode.parent && this.$vnode.parent.componentInstance && this.$vnode.parent.componentInstance.cache) {\n        if (this.$vnode.componentOptions) {\n          var key = this.$vnode.key == null\n            ? this.$vnode.componentOptions.Ctor.cid + (this.$vnode.componentOptions.tag ? `::${this.$vnode.componentOptions.tag}` : '')\n            : this.$vnode.key;\n          var cache = this.$vnode.parent.componentInstance.cache;\n          var keys = this.$vnode.parent.componentInstance.keys;\n          if (cache[key]) {\n            if (keys.length) {\n              var index = keys.indexOf(key);\n              if (index > -1) {\n                keys.splice(index, 1);\n              }\n            }\n            delete cache[key];\n          }\n        }\n      }\n    }\n    dtmp.apply(this, arguments);\n  }\n  Vue.prototype.$keepAliveDestroy = f;\n}"],"names":["createHelper","config","undefined","Vue","router","pre","canRefresh","_stack","isReplace","beforeEach","to","from","next","getCurrentVM","afterEach","nextTick","initialCb","replaceCb","console","log","isPush","pushCb","backCb","setCurrentVnodeKey","current","$vnode","parent","componentInstance","cache","keys","rtmp","replace","arg","complete","abort","apply","arguments","ptmp","push","indexOf","query","history","matched","length","instances","default","setCurrentVMStack","stack","Number","_vnode","key","path","routerStack","$keepAliveDestroy","dtmp","prototype","$destroy","this","data","keepAlive","componentOptions","Ctor","cid","tag","index","splice","warn","window"],"mappings":"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"}